<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonia Cognitive Kernel</title>
    <style>
        :root {
            --bg: #0a0a0f;
            --surface: #12121a;
            --border: #2a2a3a;
            --text: #e0e0e5;
            --text-dim: #888;
            --accent: #6366f1;
            --accent-dim: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent);
        }

        h1 span {
            color: var(--text-dim);
            font-weight: 400;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
            font-size: 0.85rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .model-select {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1000px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-body {
            padding: 16px;
        }

        .input-section {
            grid-column: 1 / -1;
        }

        .input-group {
            display: flex;
            gap: 12px;
        }

        #userInput {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 14px 16px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
        }

        #userInput:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 6px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: var(--accent-dim);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: var(--surface);
        }

        .json-view {
            background: var(--bg);
            border-radius: 4px;
            padding: 12px;
            font-size: 0.8rem;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .json-view pre {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .trace-entry {
            padding: 8px 12px;
            border-left: 3px solid var(--border);
            margin-bottom: 8px;
            font-size: 0.8rem;
        }

        .trace-entry.perception { border-color: #3b82f6; }
        .trace-entry.sensemaking { border-color: #8b5cf6; }
        .trace-entry.modeling { border-color: #ec4899; }
        .trace-entry.verification { border-color: #f59e0b; }
        .trace-entry.response { border-color: #10b981; }
        .trace-entry.error { border-color: #ef4444; }

        .trace-entry.trace-start { opacity: 0.6; }
        .trace-entry.trace-complete { border-left-width: 4px; }

        .trace-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .trace-phase {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
        }

        .trace-time {
            color: var(--text-dim);
            font-size: 0.7rem;
        }

        .memory-graph {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .memory-stats {
            display: flex;
            gap: 20px;
            font-size: 0.85rem;
        }

        .memory-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .memory-stat-value {
            font-weight: 600;
            color: var(--accent);
        }

        .node-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .node-tag {
            background: var(--bg);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .node-tag .type-badge {
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 2px;
            text-transform: uppercase;
            opacity: 0.7;
        }

        .node-tag.goal { border: 1px solid #3b82f6; }
        .node-tag.goal .type-badge { background: #3b82f6; color: white; }
        .node-tag.entity { border: 1px solid #10b981; }
        .node-tag.entity .type-badge { background: #10b981; color: white; }
        .node-tag.constraint { border: 1px solid #f59e0b; }
        .node-tag.constraint .type-badge { background: #f59e0b; color: var(--bg); }

        .response-box {
            background: var(--bg);
            padding: 16px;
            border-radius: 6px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .latency {
            color: var(--text-dim);
            font-size: 0.75rem;
            margin-top: 8px;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-dim);
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .conflict-badge {
            background: var(--warning);
            color: var(--bg);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .empty-state {
            color: var(--text-dim);
            text-align: center;
            padding: 40px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Harmonia <span>Cognitive Kernel</span></h1>
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Ready</span>
                </div>
                <div class="status-item invariant" title="For a given input, the UIL schema and verification rules remain identical across models.">
                    <span style="opacity: 0.6; font-size: 0.7rem;">Invariant: UIL schema ≡ across models</span>
                </div>
                <div class="status-item">
                    <label>Model:</label>
                    <select class="model-select" id="modelSelect">
                        <option value="mock">Mock (No API)</option>
                        <option value="openai:gpt-4o-mini">GPT-4o Mini</option>
                        <option value="openai:gpt-4o">GPT-4o</option>
                        <option value="local:llama3.2">Llama 3.2 (Local)</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="resetMemory()" title="Clears memory + trace">Reset</button>
            </div>
        </header>

        <div class="main-grid">
            <!-- Input Section -->
            <div class="panel input-section">
                <div class="panel-header">Input <span style="opacity: 0.5; font-size: 0.7rem; margin-left: 8px;">Same kernel, different cognition</span></div>
                <div class="panel-body">
                    <div class="input-group">
                        <textarea id="userInput" rows="2" placeholder="Enter a task, question, or reflection...">Plan my PhD application to ETH Zurich by December</textarea>
                        <button class="btn" id="runBtn" onclick="runPipeline()">Run PSMR</button>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" style="font-size: 0.7rem; padding: 4px 8px;" onclick="setExample('plan')">PLAN</button>
                        <button class="btn btn-secondary" style="font-size: 0.7rem; padding: 4px 8px;" onclick="setExample('decide')">DECIDE</button>
                        <button class="btn btn-secondary" style="font-size: 0.7rem; padding: 4px 8px;" onclick="setExample('analyze')">ANALYZE</button>
                        <button class="btn btn-secondary" style="font-size: 0.7rem; padding: 4px 8px;" onclick="setExample('learn')">LEARN</button>
                        <button class="btn btn-secondary" style="font-size: 0.7rem; padding: 4px 8px;" onclick="setExample('clarify')">CLARIFY</button>
                    </div>
                </div>
            </div>

            <!-- UIL Intent Panel -->
            <div class="panel">
                <div class="panel-header">
                    UIL Intent
                    <span id="intentConfidence"></span>
                </div>
                <div class="panel-body">
                    <div class="json-view" id="intentView">
                        <div class="empty-state">Run the pipeline to see parsed intent</div>
                    </div>
                </div>
            </div>

            <!-- Plan Panel -->
            <div class="panel">
                <div class="panel-header">
                    Execution Plan
                    <span id="planSteps"></span>
                </div>
                <div class="panel-body">
                    <div class="json-view" id="planView">
                        <div class="empty-state">Run the pipeline to see the plan</div>
                    </div>
                </div>
            </div>

            <!-- Verification Panel -->
            <div class="panel">
                <div class="panel-header" title="Non-LLM by design: preserves auditability and trust">
                    Verification <span style="opacity: 0.5; font-size: 0.65rem;">(rule-based)</span>
                    <span id="verificationStatus"></span>
                </div>
                <div class="panel-body">
                    <div class="json-view" id="verificationView">
                        <div class="empty-state">Run the pipeline to see verification</div>
                    </div>
                </div>
            </div>

            <!-- Trace Panel -->
            <div class="panel">
                <div class="panel-header">Execution Trace</div>
                <div class="panel-body">
                    <div id="traceView">
                        <div class="empty-state">Run the pipeline to see execution trace</div>
                    </div>
                </div>
            </div>

            <!-- Memory Panel -->
            <div class="panel">
                <div class="panel-header">Memory Graph</div>
                <div class="panel-body">
                    <div class="memory-graph" id="memoryView">
                        <div class="empty-state">Run the pipeline to see memory state</div>
                    </div>
                </div>
            </div>

            <!-- Response Panel -->
            <div class="panel">
                <div class="panel-header">
                    Response
                    <span id="latencyBadge"></span>
                </div>
                <div class="panel-body">
                    <div class="response-box" id="responseView">
                        <div class="empty-state">Run the pipeline to see the response</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';

        async function runPipeline() {
            const input = document.getElementById('userInput').value.trim();
            if (!input) return;

            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            btn.textContent = 'Running...';
            updateStatus('running', 'Processing...');

            // Clear previous results
            showLoading('intentView');
            showLoading('planView');
            showLoading('verificationView');
            showLoading('traceView');
            showLoading('memoryView');
            showLoading('responseView');

            try {
                const response = await fetch(`${API_BASE}/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        input: input,
                        include_trace: true,
                        include_memory: true
                    })
                });

                const data = await response.json();
                displayResults(data);
                updateStatus('ready', 'Ready');

            } catch (error) {
                console.error('Pipeline error:', error);
                updateStatus('error', 'Error');
                document.getElementById('responseView').innerHTML = 
                    `<div style="color: var(--error)">Error: ${error.message}</div>`;
            }

            btn.disabled = false;
            btn.textContent = 'Run PSMR';
        }

        function displayResults(data) {
            // Intent — show cognitive primitive prominently
            if (data.intent) {
                const cogType = data.intent.type;
                const domain = data.intent.domain || 'general';
                document.getElementById('intentView').innerHTML = `
                    <div style="margin-bottom: 12px;">
                        <span style="background: var(--accent); color: white; padding: 4px 10px; border-radius: 4px; font-weight: 600;">${cogType}</span>
                        <span style="background: var(--surface); padding: 4px 8px; border-radius: 4px; margin-left: 8px; font-size: 0.8rem;">domain: ${domain}</span>
                    </div>
                    <pre style="margin-top: 8px;">${JSON.stringify(data.intent, null, 2)}</pre>
                `;
                document.getElementById('intentConfidence').textContent = 
                    `${cogType} | ${(data.intent.confidence * 100).toFixed(0)}%`;
            }

            // Plan
            if (data.plan) {
                document.getElementById('planView').innerHTML = 
                    `<pre>${JSON.stringify(data.plan, null, 2)}</pre>`;
                const steps = data.plan.steps?.length || 0;
                document.getElementById('planSteps').textContent = `${steps} steps`;
            }

            // Verification
            if (data.verification) {
                document.getElementById('verificationView').innerHTML = 
                    `<pre>${JSON.stringify(data.verification, null, 2)}</pre>`;
                const status = data.verification.valid ? 'Valid' : 'Issues Found';
                const issues = data.verification.issues?.length || 0;
                document.getElementById('verificationStatus').innerHTML = 
                    issues > 0 
                        ? `<span class="conflict-badge">${issues} issues</span>`
                        : status;
            }

            // Trace
            if (data.trace && data.trace.length > 0) {
                document.getElementById('traceView').innerHTML = 
                    data.trace.map(entry => {
                        const isStart = entry.event?.includes('start') || entry.event?.includes('Start');
                        const isComplete = entry.event?.includes('complete') || entry.event?.includes('Complete');
                        const stateClass = isStart ? 'trace-start' : (isComplete ? 'trace-complete' : '');
                        return `
                        <div class="trace-entry ${entry.phase} ${stateClass}">
                            <div class="trace-header">
                                <span class="trace-phase">${entry.phase}</span>
                                <span class="trace-time">${entry.timestamp}</span>
                            </div>
                            <div>${entry.event}: ${JSON.stringify(entry.data).substring(0, 200)}...</div>
                        </div>
                    `;
                    }).join('');
            }

            // Memory
            if (data.memory_after) {
                const mem = data.memory_after;
                let memHtml = `
                    <div class="memory-stats">
                        <div class="memory-stat">
                            Nodes: <span class="memory-stat-value">${mem.node_count || 0}</span>
                        </div>
                        <div class="memory-stat">
                            Edges: <span class="memory-stat-value">${mem.edge_count || 0}</span>
                        </div>
                    </div>
                `;

                if (mem.nodes && mem.nodes.length > 0) {
                    memHtml += `
                        <div class="node-list">
                            ${mem.nodes.map(n => {
                                // Handle different node formats from NetworkX
                                let nodeId, nodeType, nodeLabel;
                                
                                if (Array.isArray(n)) {
                                    // NetworkX format: [id, {data}]
                                    nodeId = n[0];
                                    const nodeData = n[1] || {};
                                    nodeType = nodeData.type || 'entity';
                                    nodeLabel = nodeData.text || nodeData.name || nodeId;
                                } else if (typeof n === 'object') {
                                    nodeId = n.id || 'unknown';
                                    nodeType = n.type || 'entity';
                                    nodeLabel = n.text || n.name || n.label || nodeId;
                                } else {
                                    nodeId = String(n);
                                    nodeType = 'entity';
                                    nodeLabel = nodeId;
                                }
                                
                                // Truncate long labels
                                if (nodeLabel.length > 30) {
                                    nodeLabel = nodeLabel.substring(0, 27) + '...';
                                }
                                
                                return `<span class="node-tag ${nodeType}"><span class="type-badge">${nodeType}</span>${nodeLabel}</span>`;
                            }).join('')}
                        </div>
                    `;
                }

                document.getElementById('memoryView').innerHTML = memHtml;
            }

            // Response - render markdown-style formatting
            if (data.response) {
                // Simple markdown rendering
                let html = data.response
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>')
                    .replace(/  • /g, '&nbsp;&nbsp;• ');
                document.getElementById('responseView').innerHTML = html;
            }

            // Latency + fallback indicator
            if (data.latency_ms) {
                let badge = `${data.latency_ms.toFixed(0)}ms | ${data.model_used}`;
                if (data.used_fallback) {
                    badge += ' <span style="color: var(--warning); font-size: 0.7rem;">(fallback)</span>';
                }
                document.getElementById('latencyBadge').innerHTML = badge;
            }
        }

        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Processing...</span>
                </div>
            `;
        }

        function updateStatus(status, text) {
            const dot = document.getElementById('statusDot');
            const textEl = document.getElementById('statusText');
            
            textEl.textContent = text;
            
            if (status === 'running') {
                dot.style.background = 'var(--accent)';
            } else if (status === 'error') {
                dot.style.background = 'var(--error)';
            } else {
                dot.style.background = 'var(--success)';
            }
        }

        async function switchModel() {
            const select = document.getElementById('modelSelect');
            const [provider, model] = select.value.split(':');
            
            try {
                await fetch(`${API_BASE}/switch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        provider: provider,
                        model: model || null
                    })
                });
            } catch (error) {
                console.error('Failed to switch model:', error);
            }
        }

        async function resetMemory() {
            try {
                await fetch(`${API_BASE}/reset`, { method: 'POST' });
                // Clear UI
                document.getElementById('intentView').innerHTML = 
                    '<div class="empty-state">Memory reset. Run the pipeline again.</div>';
                document.getElementById('planView').innerHTML = 
                    '<div class="empty-state">Memory reset.</div>';
                document.getElementById('verificationView').innerHTML = 
                    '<div class="empty-state">Memory reset.</div>';
                document.getElementById('traceView').innerHTML = 
                    '<div class="empty-state">Memory reset.</div>';
                document.getElementById('memoryView').innerHTML = 
                    '<div class="empty-state">Memory reset.</div>';
                document.getElementById('responseView').innerHTML = 
                    '<div class="empty-state">Memory reset.</div>';
            } catch (error) {
                console.error('Failed to reset:', error);
            }
        }

        // Model change listener
        document.getElementById('modelSelect').addEventListener('change', switchModel);

        // Enter key to run
        document.getElementById('userInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                runPipeline();
            }
        });

        // =================================================================
        // COGNITIVE PRIMITIVE EXAMPLES
        // Same kernel, same schema — different cognition
        // =================================================================
        const EXAMPLES = {
            plan: "Plan my PhD application to ETH Zurich by December",
            decide: "Decide whether I should apply to ETH or EPFL for my PhD",
            analyze: "Analyze the risks of submitting a late PhD application",
            learn: "Explain the steps of a PhD application in Switzerland",
            clarify: "Clarify what documents are required for ETH PhD admission"
        };

        function setExample(type) {
            document.getElementById('userInput').value = EXAMPLES[type];
        }
    </script>
</body>
</html>
